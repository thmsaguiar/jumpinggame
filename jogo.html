<!doctype html>
<html>
	<head>
		<meta charset="UTF-8"/>
		<title>Minha engine</title>
		<style>
			canvas{
				position: absolute;
				top:  0px;
				bottom:  0px;
				left: 0px;
				right: 0px;
				margin: auto;
			}
		</style>
	</head>
	<body>
		<script  type="text/javascript">
			//variáveis do jogo
			var canvas, ctx, HEIGHT, WIDTH, frames = 0, maxJump = 3, velocity = 6, currentState,
			states = {
				play: 0,
				playing: 1,
				failed: 2
			},
			floor = {
				y: 550,
				height: 50,
				color: "#ffdf70",
				drawing: function(){
					ctx.fillStyle = this.color;
					ctx.fillRect(0, this.y, WIDTH, this.height);
				}
			}, 
			charctmain = {
				x: 50,
				y: 0,
				height: 50,
				width: 50,
				color: "#ff4e4e",
				gravity: 1.6,
				velocity: 0,
				strengthJump: 23.6,
				qtdJump: 0,
				score: 0,
				update: function(){
					this.velocity += this.gravity;
					this.y += this.velocity;
					if(this.y > floor.y - this.height && currentState != states.failed){
						this.y = floor.y - this.height;
						this.qtdJump = 0;
						this.velocity = 0;
					}
				},
				reset: function(){
					this.velocity = 0;
					this.y = 0;
					this.score = 0;
				},
				jump: function(){
					if(this.qtdJump < maxJump){
						this.velocity = -this.strengthJump;
						this.qtdJump++;
					}					
				},
				drawing: function(){
					ctx.fillStyle = this.color;
					ctx.fillRect(this.x, this.y, this.width, this.height);
				}
			},
			obstacles = {
				_obs: [],
				colors: ["#ffbc1c", "#ff85e1", "#ff1c1c", "#52a7ff", "#78ff5d"],
				timeInsert: 0,
				insert: function(){
					this._obs.push({
						x: WIDTH,
						//width: 30 + Math.floor(21 * Math.random()),
						width: 50,
						height: 30 + Math.floor(120 * Math.random()),
						color: this.colors[Math.floor(5 * Math.random())]
					});					
					this.timeInsert = 40 + Math.floor(26 * Math.random());
				},
				update: function(){
					if(this.timeInsert == 0)
						this.insert();
					else
						this.timeInsert--;

					for (var i = 0, tam = this._obs.length; i < tam; i++){
						var obs = this._obs[i];
						obs.x -= velocity;
						if(charctmain.x < obs.x + obs.width && charctmain.x + charctmain.width >= obs.x && charctmain.y + charctmain.height >= floor.y - obs.height){
							currentState = states.failed;
						}else if(obs.x == 0){
							charctmain.score++;
						}else if(obs.x <= -obs.width){
							this._obs.splice(i, 1);
							tam--;
							i--;
						}
					}
				},
				clear: function(){
					this._obs = [];
				},
				drawing: function(){
					for (var i = 0, tam = this._obs.length; i<tam; i++){
						var obs = this._obs[i];
						ctx.fillStyle = obs.color;
						ctx.fillRect(obs.x, floor.y-obs.height, obs.width, obs.height);
					}
				}
			};

			function click(event){
				if(currentState == states.playing)
					charctmain.jump();
				else if(currentState == states.play){
					currentState = states.playing;
				}else if(currentState == states.failed && charctmain.y >= 2*HEIGHT){
					currentState = states.play;					
					obstacles.clear();			
					charctmain.reset();	
				}
			}

			//função principal
			function main(){

				HEIGHT = window.innerHeight;
				WIDTH = window.innerWidth;

				if(WIDTH >= 500){
					//setando valor da janela
					HEIGHT = 600;
					WIDTH = 600;					
				}

				//criando o canvas
				canvas = document.createElement("canvas");
				canvas.width = WIDTH;
				canvas.height = HEIGHT;
				canvas.style.border = "1px solid #000";
				
				ctx = canvas.getContext("2d");

				document.body.appendChild(canvas);
				document.addEventListener("mousedown", click);

				currentState = states.play;
				loop();
			}

			
			function loop(){
				update();
				drawing();

				window.requestAnimationFrame(loop);
			}

			function update(){
				frames++;
				charctmain.update();
				if(currentState == states.playing){
					obstacles.update();	
				}
			}

			function drawing(){
				ctx.fillStyle = "#50beff";
				ctx.fillRect(0, 0, WIDTH, HEIGHT);

				ctx.fillStyle = "#fff";
				ctx.font = "50px Arial";
				ctx.fillText(charctmain.score, 30, 68);				

				if(currentState == states.play){
					ctx.fillStyle = "green";
					ctx.fillRect(WIDTH/2 - 50, HEIGHT/2 - 50, 100, 100);
				}else if(currentState == states.failed){
					ctx.fillStyle = "red";
					ctx.fillRect(WIDTH/2 - 50, HEIGHT/2 - 50, 100, 100);
					ctx.save();
					ctx.translate(WIDTH/2, HEIGHT/2);
					ctx.fillStyle = "#fff";
					if(charctmain.score < 10)
						ctx.fillText(charctmain.score, -13, 19);
					else if(charctmain.score >= 10 && charctmain.score< 100)
						ctx.fillText(charctmain.score, -26, 19);
					else
						ctx.fillText(charctmain.score, -39, 19);
					ctx.restore();
				}else if(currentState == states.playing){
					obstacles.drawing();
				}

				floor.drawing();								
				charctmain.drawing();

			}

			//inicializando o jogo
			main();
		</script>		
	</body>
</html>